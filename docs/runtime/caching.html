<!DOCTYPE HTML>
<html lang="en" >
    <head><meta charset="UTF-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"><title>Caching Â· Enso Developer Documentation</title><meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="description" content="The developer documentation for the Enso compiler, runtime, and IDE..
"><meta name="generator" content="Jekyll (using style of GitBook 3.2.3)"><meta name="author" content="Enso.org"><link rel="stylesheet" href="/gitbook/style.css">
<link rel="stylesheet" href="/gitbook/gitbook-plugin-fontsettings/website.css">
<!-- <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css"> -->

<link rel="stylesheet" href="/gitbook/rouge-highlight-colorful.css">

<meta name="HandheldFriendly" content="true"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/gitbook/images/apple-touch-icon-precomposed-152.png">
<link rel="shortcut icon" href="/gitbook/images/favicon.ico" type="image/x-icon">
        

        
        


        
        
        

        
        
        

        
            <link rel="prev" href="/docs/runtime/" />
        

        
            <link rel="next" href="/docs/runtime/demand-analysis.html" />
        
    </head>
    <body>
        
        <div class="book"><div class="book-summary">
    <div id="search-searchbar">
    </div>
    <div class="post-list" id="search-hits">
        
      </div>
      <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">

<script>
var search = instantsearch({
  appId: '3PBI3MMCBE',
  apiKey: '55d673c313b717b7386df8c9418588d4',
  indexName: 'jekyll',
  searchFunction(helper) {
    var container = document.querySelector('#search-hits');
    container.style.display = helper.state.query === '' ? 'none' : '';

    helper.search();
  }
});

var hitTemplate = function(hit) {
  let date = '';
  if (hit.date) {
    date = moment.unix(hit.date).format('MMM D, YYYY');
  }

  let url = `${hit.url}#${hit.anchor}`;

  var title = hit._highlightResult.title.value;

  var content = hit._highlightResult.html.value;

  return `
    <li class="post-item chapter">
      <a href="${url}" class="post-link">${title}</a>
      <div class="post-snippet">${content}</div>
    </li>
  `;
}


search.addWidget(
  instantsearch.widgets.searchBox({
    container: '#search-searchbar',
    placeholder: 'Search the docs',
    poweredBy: true // This is required if you're on the free Community plan
  })
);

search.addWidget(
  instantsearch.widgets.hits({
    container: '#search-hits',
    templates: {
      item: hitTemplate
    }
  })
);

search.start();
</script>

<style>
.ais-search-box {
  max-width: 100%;
  margin-bottom: 15px;
}
.post-item {
  margin-bottom: 30px;
}
.post-link .ais-Highlight {
  color: #111;
  font-style: normal;
  text-decoration: underline;
}
.post-breadcrumbs {
  color: #424242;
  display: block;
}
.post-breadcrumb {
  font-size: 18px;
  color: #424242;
}
.post-breadcrumb .ais-Highlight {
  font-weight: bold;
  font-style: normal;
}
.post-snippet .ais-Highlight {
  color: #2a7ae2;
  font-style: normal;
  font-weight: bold;
}
.post-snippet img {
  display: none;
}

.post-list {
    list-style:none;
    margin:0;
    padding: 10px 15px;
    -webkit-transition:top .5s ease;
    -moz-transition:top .5s ease;
    -o-transition:top .5s ease;
    transition:top .5s ease
}

#search-hits::after {
    content: '';
    display: block;
    height: 1px;
    margin: 7px 0;
    overflow: hidden;
    background: rgba(0,0,0,.07);
}
</style>
    <nav role="navigation">
        <ul class="summary">
            
            <li class="chapter" data-level="1.1" data-path="/">
            
                <a href="/">
                    Home
                </a>
            </li>

            <li class="divider"></li>

            
            
            

            
            
        
            
            <li class="chapter" data-level="1.1" data-path="/docs/runtime ">
                    <a href="/docs/runtime">
                        Go back
                    </a>
                </li>
                <li class="divider"></li>
            
                
            
            
            
            
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
                    
                    <li class="chapter" data-level="1.1" data-path="/docs/runtime/">
                    
                        <a href="/docs/runtime/">
                            
                                Enso Runtime
                            
                        </a>
                    </li>
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
                    
                    <li class="chapter active" data-level="1.2" data-path="/docs/runtime/caching.html">
                    
                        <a href="/docs/runtime/caching.html">
                            
                                Caching
                            
                        </a>
                    </li>
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
                    
                    <li class="chapter" data-level="1.1" data-path="/docs/runtime/demand-analysis.html">
                    
                        <a href="/docs/runtime/demand-analysis.html">
                            
                                Demand Analysis
                            
                        </a>
                    </li>
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
                    
                    <li class="chapter" data-level="1.1" data-path="/docs/runtime/function-call-flow.html">
                    
                        <a href="/docs/runtime/function-call-flow.html">
                            
                                Function Calling Flow
                            
                        </a>
                    </li>
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
                    
                    <li class="chapter" data-level="1.1" data-path="/docs/runtime/runtime-features.html">
                    
                        <a href="/docs/runtime/runtime-features.html">
                            
                                Runtime Features
                            
                        </a>
                    </li>
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
                    
                    <li class="chapter" data-level="1.1" data-path="/docs/runtime/unbounded-recursion.html">
                    
                        <a href="/docs/runtime/unbounded-recursion.html">
                            
                                Unbounded Recursion
                            
                        </a>
                    </li>
                
            
            
            
                
            
            
            
                
            
            
            
                
                    
                    <li class="chapter" data-level="1.1" data-path="/docs/runtime/execution-server-flow.html">
                    
                        <a href="/docs/runtime/execution-server-flow.html">
                            
                                Execution Server Flow
                            
                        </a>
                    </li>
                
            
            
            
                
                    
                    <li class="chapter" data-level="1.1" data-path="/docs/runtime/instruments.html">
                    
                        <a href="/docs/runtime/instruments.html">
                            
                                Instruments
                            
                        </a>
                    </li>
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
                    
                    <li class="chapter" data-level="1.1" data-path="/docs/runtime/searcher.html">
                    
                        <a href="/docs/runtime/searcher.html">
                            
                                Searcher
                            
                        </a>
                    </li>
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            
            
                
            
            

            
        
        </ul>
    </nav>
</div>
<div class="book-body"><div class="body-inner">
    <div class="book-header" role="navigation">
        <!-- Title -->
        <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i>
            
                <a href="." >Caching</a>
            
        </h1>
    </div>
    <div class="page-wrapper" tabindex="-1" role="main">
        <div class="page-inner">
            <div id="book-search-results">
                <div class="search-noresults">
                    <section class="normal markdown-section">
                        <h1 id="caching">Caching</h1>
<p>It is not uncommon for users in data-analysis jobs to work with data on the
order of <em>gigabytes</em> or even <em>terabytes</em>. As fast as computers have become, and
as efficient as programming languages can be, you still donât want to compute on
such large amounts of data unless you absolutely have to.</p>

<p>This wouldnât usually be an issue, with such data-analysis tasks being able to
run in a âbatch modeâ, where the user starts their job in a fire-and-forget
fashion. Enso, however, is a highly <em>interactive</em> environment for working with
data, where waiting <em>seconds</em>, let alone <em>hours</em>, would severely hamper the user
experience.</p>

<p>Given that Enso is a highly interactive language and platform, we want to take
every measure to ensure that we provide a highly responsive experience to our
users. To that end, one of the key tenets of the new runtimeâs featureset for
aiding in this is the inclusion of a <em>caching</em> mechanism.</p>

<p>Caching, in this case, refers to the runtimeâs ability to ârememberâ the values
computed in the currently observed scopes. In combination with the data
dependency analysis performed by the compiler, this allows the runtime to
recompute the <em>minimal</em> set of expressions when the user makes a change, rather
than having to recompute the entire program.</p>

<!-- MarkdownTOC levels="2,3" autolink="true" -->

<ul>
  <li><a href="#cache-candidates">Cache Candidates</a>
    <ul>
      <li><a href="#initial-cache-candidates">Initial Cache Candidates</a></li>
      <li><a href="#further-development-of-cache-candidates">Further Development of Cache Candidates</a></li>
    </ul>
  </li>
  <li><a href="#partial-evaluation-and-side-effects">Partial-Evaluation and Side-Effects</a>
    <ul>
      <li><a href="#side-effects-in-the-initial-version">Side Effects in the Initial Version</a></li>
      <li><a href="#in-the-future">In The Future</a></li>
    </ul>
  </li>
  <li><a href="#cache-eviction-strategy">Cache Eviction Strategy</a>
    <ul>
      <li><a href="#initial-eviction-strategy">Initial Eviction Strategy</a></li>
      <li><a href="#future-eviction-strategies">Future Eviction Strategies</a></li>
    </ul>
  </li>
  <li><a href="#dataflow-analysis">Dataflow Analysis</a>
    <ul>
      <li><a href="#identifying-expressions">Identifying Expressions</a></li>
      <li><a href="#specifying-dataflow">Specifying Dataflow</a></li>
    </ul>
  </li>
  <li><a href="#cache-backend">Cache Backend</a>
    <ul>
      <li><a href="#initial-implementation-of-cache-backend">Initial Implementation of Cache Backend</a></li>
      <li><a href="#further-development-of-cache-backend">Further Development of Cache Backend</a></li>
    </ul>
  </li>
  <li><a href="#memory-bounded-caches">Memory Bounded Caches</a>
    <ul>
      <li><a href="#soft-references">Soft References</a></li>
      <li><a href="#serialization">Serialization</a></li>
      <li><a href="#instrumentation">Instrumentation</a></li>
      <li><a href="#manual-memory-management">Manual Memory Management</a></li>
      <li><a href="#comparison-of-memory-management-approaches">Comparison of Memory Management Approaches</a></li>
    </ul>
  </li>
</ul>

<!-- /MarkdownTOC -->

<h2 id="cache-candidates">Cache Candidates</h2>
<p>The key use of the Enso value cache is to support the interactive editing of
user code. This means that it caches all bindings within the scope of a given
function, including the function arguments. This means that, as users edit their
code, we can ensure that the minimal amount of their program is recomputed.</p>

<p>Consider the following example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">foo</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="nf">frob</span> <span class="n">b</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="nf">wibble</span> <span class="n">b</span>
    <span class="n">a</span><span class="p">.</span><span class="nf">quux</span> <span class="n">d</span>
</code></pre></div></div>

<p>The cache is active for the <em>currently visible scope</em> in Enso Studio, so when a
user enters the function <code class="language-plaintext highlighter-rouge">foo</code>, the cache stores the intermediate results in
this function (in this case <code class="language-plaintext highlighter-rouge">c</code> and <code class="language-plaintext highlighter-rouge">d</code>), as well as the inputs to the function
(in this case <code class="language-plaintext highlighter-rouge">a</code>, and <code class="language-plaintext highlighter-rouge">b</code>).</p>

<p>All intermediate results and inputs are considered as candidates, though as the
cache design evolves, the <em>selected</em> candidates may be refined. Ultimately we
want to cache and reuse as much as possible to minimize the computation
costs. At the same time, we want to limit the memory consumed by the cache.</p>

<h3 id="initial-cache-candidates">Initial Cache Candidates</h3>
<p>The initial version of the cache only stores the right-hand-sides of binding
expressions. This is for two main reasons:</p>

<ul>
  <li>Firstly, this allows us to ensure that the cache does not cause the JVM to
go out of memory between executions, allowing us to avoid the implementation
of a <a href="#memory-management">memory-bounded cache</a> for now.</li>
  <li>It also simplifies the initial implementation of weighting program components.</li>
</ul>

<h3 id="further-development-of-cache-candidates">Further Development of Cache Candidates</h3>
<p>The next step for the cache is to expand the portions of the introspected scope
that we cache. In general, this means the caching of intermediate expressions.</p>

<p>However, once we do this, we can no longer guarantee that we do not push the
JVM out of memory between two program executions. This is best demonstrated
by example.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a = (computeHugeObject b).size
</code></pre></div></div>

<p>Here we compute a value that takes up a significant amount of memory, but from
it we only compute a small derived value (its size). Hence, if we want to cache
the intermediate result of the discarded <code class="language-plaintext highlighter-rouge">computeHugeObject b</code> expression, we
need some way of tracking the sizes of individual cache entries.</p>

<h2 id="partial-evaluation-and-side-effects">Partial-Evaluation and Side-Effects</h2>
<p>The more theoretically-minded people among those reading this document may
instantly realise that there is a <em>problem</em> with this approach. In the presence
of caching, it becomes <em>entirely</em> unpredictable as to when side effects are
executed. This is problematic in that side-effecting computations are rarely
idempotent, and problems might be caused by executing them over and over again.</p>

<p>Furthermore, the nature of the interpreterâs support for entering functions
inherently requires that it recompute portions of that function in a different
context, thereby potentially re-evaluating side-effecting computations as well.</p>

<p>In general, it is clear that many kinds of side effect have <em>problems</em> in the
presence of caching and partial-evaluation.</p>

<h3 id="side-effects-in-the-initial-version">Side Effects in the Initial Version</h3>
<p>Many of the mechanisms required to deal with this kind of issue properly are
complex and require deep type-level support in the compiler. To that end, the
initial version of the interpreter is going to pretend that the problem doesnât
really exist.</p>

<ul>
  <li>All intermediate values will be cached.</li>
  <li>Cached values will be recomputed as necessary as described in the section on
<a href="#initial-eviction-strategies">initial eviction strategies</a>.</li>
</ul>

<p>This can and <em>will</em> recompute side-effecting computations indiscriminately, but
we cannot initially do much better.</p>

<h4 id="a-stopgap">A Stopgap</h4>
<p>While the compiler wonât have the machinery in place to properly track
information about side-effects, we can implement a stop-gap solution that at
least allows the GUI to allow users to make the decision about whether or not to
recompute a side-effecting value. This is very similar to the initial approach
used for functions with arguments marked as <code class="language-plaintext highlighter-rouge">Suspended</code>, and works as follows:</p>

<ul>
  <li>We provide explicit signatures (containing <code class="language-plaintext highlighter-rouge">IO</code>) for functions that perform
side-effects.</li>
  <li>Whenever the runtime wants to recompute a value that performs side-effects, it
can use this information to ask for user input.</li>
  <li>We can also display a box on these types <code class="language-plaintext highlighter-rouge">always_reevaluate</code> that lets users
opt in to automatic re-evaluation of these values.</li>
</ul>

<h3 id="in-the-future">In The Future</h3>
<p>As the compiler evolves, however, we can do better than this. In particular, we
can employ type-system information to determine which functions are
side-effecting (in absence of annotations), and to class some kinds of said
functions as safe for either caching, re-evaluation, or both. What follows is a
brief sketch of how this might work:</p>

<ul>
  <li>Rather than having a single type capturing side effects (like <code class="language-plaintext highlighter-rouge">IO</code> in Haskell)
we divide the type up into fine-grained descriptions of side-effects that let
us better describe the particular behaviours of given functions (e.g.
<code class="language-plaintext highlighter-rouge">IO.Read</code>, <code class="language-plaintext highlighter-rouge">IO.Write</code>), all of which are more-specific versions of the base
<code class="language-plaintext highlighter-rouge">IO</code> type.</li>
  <li>We provide a set of interfaces that determine whether a given kind of side
effect can be safely cached or re-evaluated (e.g. <code class="language-plaintext highlighter-rouge">No_Cache</code> or
<code class="language-plaintext highlighter-rouge">No_Reevaluate</code>).</li>
  <li>We can use this information to ask the user about recomputation in far less
situations.</li>
</ul>

<blockquote>
  <p>The actionables for this section are:</p>

  <ul>
    <li>Evolve the strategy for handling side effects as the compiler provides more
capabilities that will be useful in doing so.</li>
  </ul>
</blockquote>

<h2 id="cache-eviction-strategy">Cache Eviction Strategy</h2>
<p>The cache eviction strategy refers to the method by which we determine which
entries in the cache are invalidated (if any) after a given change to the code.</p>

<h3 id="initial-eviction-strategy">Initial Eviction Strategy</h3>
<p>In the initial version of the caching mechanism, the eviction strategies are
intended to be fairly simplistic and conservative to ensure correctness.</p>

<ul>
  <li>The compiler performs data-dependency analysis between expressions.</li>
  <li>If an expression is changed, all cached values for expressions that depend on
it are evicted from the cache.</li>
  <li>Expressions that have been evicted from the cache subsequently have to be
recomputed by the runtime.</li>
</ul>

<p>The following rules are applied when an expression identified by some key <code class="language-plaintext highlighter-rouge">k</code> is
changed:</p>

<ol>
  <li>All expressions that depend on the result of <code class="language-plaintext highlighter-rouge">k</code> are evicted from the cache.</li>
  <li>If <code class="language-plaintext highlighter-rouge">k</code> is a dynamic symbol, all expressions that depend on <em>any instance</em> of
the dynamic symbol are evicted from the cache.</li>
</ol>

<h3 id="future-eviction-strategies">Future Eviction Strategies</h3>
<p>In the future, however, the increasing sophistication of the front-end compiler
for Enso will allow us to do better than this by accounting for more granular
information in the eviction decisions.</p>

<p>Cache eviction takes into account the following aspects:</p>

<ul>
  <li><strong>Visualization:</strong> In the first place, we should care about nodes that have
visualization attached in the IDE.</li>
  <li><strong>Priority:</strong> The runtime can assign a score to a node, meaning how valuable
this node is. Less valuable nodes should be evicted first.</li>
  <li><strong>Computation time:</strong> The runtime can calculate the time that node took to
compute. Less computationally intensive nodes should be evicted first. Memory
limit. The cache should not exceed the specified memory limit.</li>
</ul>

<blockquote>
  <p>The actionables for this section are:</p>

  <ul>
    <li>Evolve the cache eviction strategy by employing more granular information
as the compiler evolves to provide it.</li>
  </ul>
</blockquote>

<h2 id="dataflow-analysis">Dataflow Analysis</h2>
<p>Dataflow analysis is the process by which the compiler discovers the
relationships between program expressions. The output of the process is a data
dependency graph that can be queried for an expression, and returns the set of
all expressions that depended on that expression.</p>

<p>Internally we represent this as a directed graph:</p>

<ul>
  <li>An edge from <code class="language-plaintext highlighter-rouge">a</code> to <code class="language-plaintext highlighter-rouge">b</code> indicates that the expression <code class="language-plaintext highlighter-rouge">a</code> is depended on by
the expression <code class="language-plaintext highlighter-rouge">b</code>.</li>
  <li>These dependencies are <em>direct</em> dependencies on <code class="language-plaintext highlighter-rouge">a</code>.</li>
  <li>We reconstruct transitive dependencies from this graph.</li>
</ul>

<p>An expression <code class="language-plaintext highlighter-rouge">a</code> can be any Enso expression, including definitions of dynamic
symbols. Given that dynamic symbols need not be in scope, care has to be taken
with registering them properly.</p>

<p>Each expression in the compiler IR is annotated with both the set of expressions
that depend on it, and the set of expressions that it depends on.</p>

<h3 id="identifying-expressions">Identifying Expressions</h3>
<p>Expressions are identified, for the purposes of dataflow analysis, by unique
identifiers on every IR node. The dataflow analysis process creates a dependency
graph between these identifiers.</p>

<p>However, at runtime, the IDE uses a different and separate concept of
identifiers. Translating between these external identifiers and the internal
identifiers is left to the runtime and is not the responsibility of the dataflow
analysis pass.</p>

<h3 id="specifying-dataflow">Specifying Dataflow</h3>
<p>Dataflow analysis takes place on the core set of language constructs, defined
as those that extend <code class="language-plaintext highlighter-rouge">IRKind.Primitive</code>. Their dataflow is specified as follows,
with arrows representing edges in the graph.</p>

<h4 id="atom">Atom</h4>
<p>An atom is dependent on the definitions of its arguments, particularly with
regard to any defaults.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>atom &lt;- arguments
</code></pre></div></div>

<h4 id="method">Method</h4>
<p>A method is dependent on the definition of its body. Methods at the point that
dataflow analysis runs are âbareâ methods, meaning that they are defined as
functions.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>method &lt;- body
</code></pre></div></div>

<h4 id="block">Block</h4>
<p>The value of a block is dependent purely on the value of its return expression.
The return expression may depend on other values.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>block &lt;- returnValue
</code></pre></div></div>

<h4 id="binding">Binding</h4>
<p>The value of a binding is dependent both on the name of the binding and the
expression being assigned in the binding.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>binding &lt;- name
binding &lt;- expression
</code></pre></div></div>

<h4 id="lambda">Lambda</h4>
<p>The value of a lambda is dependent on the return value from its body, as well as
the definitions of any defaults for its arguments.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lambda &lt;- body
lambda &lt;- argumentDefaults
</code></pre></div></div>

<h4 id="definition-argument">Definition Argument</h4>
<p>The value of a function definition argument is dependent purely on the value of
its default, if that default is present.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defArgument &lt;- defaultExpression
</code></pre></div></div>

<h4 id="prefix-application">Prefix Application</h4>
<p>The value of a prefix application is dependent on the values of both the
function expression being called, and the arguments.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>prefix &lt;- function
prefix &lt;- arguments
</code></pre></div></div>

<h4 id="call-argument">Call Argument</h4>
<p>The value of a call argument is dependent both on the value that itâs wrapping,
as well as the name it has, if it exists.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>callArgument &lt;- argumentValue
callArgument &lt;- argumentName
</code></pre></div></div>

<h4 id="forced-term">Forced Term</h4>
<p>A forced term is purely dependent on the value of the term being forced (the
<code class="language-plaintext highlighter-rouge">target</code>).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>force &lt;- target
</code></pre></div></div>

<h4 id="typeset-members">Typeset Members</h4>
<p>A typeset member is dependent on the definition of its label, as well as the
possibly present definitions of its type and value.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typesetMember &lt;- label
typesetMember &lt;- memberType
typesetMember &lt;- memberValue
</code></pre></div></div>

<h4 id="typing-operators">Typing Operators</h4>
<p>All typing operators in Enso (<code class="language-plaintext highlighter-rouge">IR.Type</code>) are dependent on their constituent
parts:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typingExpr &lt;- expressionChildren
</code></pre></div></div>

<h4 id="name">Name</h4>
<p>An occurrence of a name is dependent on the definition site of that name. This
means that it is broken down into two options:</p>

<ol>
  <li>
    <p><strong>Static Dependency:</strong> The definition site for a given usage can be
statically resolved.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>name &lt;- staticUseSite
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>Dynamic Dependency:</strong> The definition site for a given usage can only be
determined to be a symbol resolved dynamically.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>name &lt;- dynamicSymbol
</code></pre></div>    </div>

    <p>Under these circumstances, if any definition for <code class="language-plaintext highlighter-rouge">dynamicSymbol</code> changes,
then <em>all</em> usages of that symbol must be invalidated, whether or not they
used the changed definition in particular.</p>
  </li>
</ol>

<h4 id="case-expressions">Case Expressions</h4>
<p>The value of a case expression depends on the value of its scrutinee, as well
as the definitions of its branches.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>case &lt;- scrutinee
case &lt;- branches
case &lt;- fallback
</code></pre></div></div>

<h4 id="case-branches">Case Branches</h4>
<p>The value of a case branch depends on both the pattern expression and the result
expression.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>caseBranch &lt;- casePattern
caseBranch &lt;- expression
</code></pre></div></div>

<h4 id="comments">Comments</h4>
<p>The value of a comment is purely dependent on the value of the commented entity.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>comment &lt;- commented
</code></pre></div></div>

<h2 id="cache-backend">Cache Backend</h2>
<p>The cache is implemented as key-value storage with an eviction function.</p>

<p>The cache stores the right-hand side expressions of the bindings in the
key-value storage. The storage can be as simple as a Hash Map with values
wrapped into the Soft References as a fallback strategy of clearing the
cache. The eviction function purges invalidated expressions from previous
program execution.</p>

<h3 id="further-development">Further development</h3>
<p>Cache intermediate results of expressions to reduce the cost of new computations
and extend the eviction strategy to clear the cache based on memory consumption.</p>

<p>Extend the eviction strategy by adding an asynchronous scoring task that
computes some properties of stored objects (e.g., the size of the object). Those
properties can be used in the eviction strategy as optional clues, improving the
hit ratio.</p>

<blockquote>
  <p>The actionables for this section are:</p>

  <ul>
    <li>
      <p>Evolve the cache by storing the results of intermediate expressions</p>
    </li>
    <li>
      <p>Evolve the cache eviction strategy implementation by employing more
information of the stored values</p>
    </li>
  </ul>
</blockquote>

<h2 id="memory-bounded-caches">Memory Bounded Caches</h2>
<p>Memory management refers to a way of controlling the size of the cache, avoiding
the Out Of Memory errors.</p>

<p>The methods below can be divided into two approaches.</p>

<ol>
  <li>Limiting the overall JVM memory and relying on garbage collection.</li>
  <li>Calculating the objectâs size and using it in the eviction strategy.</li>
</ol>

<p>In general, to control the memory size on JVM, anything besides limiting the
total amount involves some tradeoffs.</p>

<h3 id="soft-references">Soft References</h3>
<p>Soft References is a way to mark the cache entries available for garbage
collection whenever JVM runs a GC. In practice, it can cause long GC times and
reduced overall performance. This strategy is generally considered as a last
resort measure.</p>

<p>The effect of the GC can be mitigated by using the <em>isolates</em> (JSR121
implemented in GraalVM). One can think of an <em>isolate</em> as a lightweight JVM,
running in a thread with their own heap, memory limit, and garbage collection.</p>

<p>The problem is that <em>isolates</em> canât share objects. And even if we move the
cache to the separate <em>isolate</em>, that would require creating a mechanism of
sharing objects based on pointers, which requires implementing serialization. On
the other hand, serialization itself can provide the size of the object, which
is enough to implement the eviction policy, even without running the <em>isolates</em>.</p>

<h3 id="serialization">Serialization</h3>
<p>One approach to get the size of the value stored in the cache is
<em>serialization</em>. The downside is the computational overhead of transforming the
object into a byte sequence.</p>

<h3 id="instrumentation">Instrumentation</h3>
<p>Another way of getting the objectâs size is to use JVM instrumentation. This
approach requires running JVM with <em>javaagent</em> attached, which can complicate
the deployment and have indirect performance penalties.</p>

<h3 id="manual-memory-management">Manual Memory Management</h3>
<p>This method implies tracking the size of the values by hand. It can be done for
the values of Enso language, knowing the size of its primitive types. For
interacting with other languages, Enso can provide an interface that developers
should implement to have a better experience with the cache.</p>

<h3 id="comparison-of-memory-management-approaches">Comparison of Memory Management Approaches</h3>
<p>Below are some key takeaways after experimenting with the <em>instrumentation</em> and
<em>serialization</em> approaches.</p>

<h4 id="enso-runtime-benchmark">Enso Runtime Benchmark</h4>
<p>The existing runtime benchmark was executed with the java agent attached to
measure the impact of instrumentation.</p>

<h4 id="serialization-benchmark">Serialization Benchmark</h4>
<p><a href="https://github.com/RuedigerMoeller/fast-serialization">FST</a> library was used
for the serialization benchmark. It doesnât require an explicit scheme and
relies on Java <code class="language-plaintext highlighter-rouge">Serializable</code> interface.</p>

<h4 id="instrumentation-benchmark">Instrumentation Benchmark</h4>
<p>Java
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/Instrumentation.html">`Instrumentation#getObjectSize()</a>
can only provide a <em>shallow</em> memory of the object. It does not follow the
references and only takes into account public fields containing primitive types.</p>

<p>Benchmark used the <code class="language-plaintext highlighter-rouge">MemoryUtil#deepMemoryUsageOf</code> function of
<a href="https://www.javamex.com/classmexer/">Classmexer</a> library. It utilizes Java
reflection to follow the references and access the private fields of the object.</p>

<h4 id="benchmark-results">Benchmark Results</h4>
<p>Benchmarks measured Java array, <code class="language-plaintext highlighter-rouge">java.util.LinkedList</code>, and a custom
implementation of lined list <code class="language-plaintext highlighter-rouge">ConsList</code>, an object that maintains references for
its head and tail.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ConsList</span><span class="o">&lt;</span><span class="no">A</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="no">A</span> <span class="n">head</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">ConsList</span><span class="o">&lt;</span><span class="no">A</span><span class="o">&gt;</span> <span class="n">tail</span><span class="o">;</span>
<span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Function execution time measured in milliseconds per operation (lower is
better).</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Benchmark                               (size)  Mode  Cnt     Score     Error  Units
FstBenchmark.serializeArray               1000  avgt    5    21.862 Â±   0.503  us/op
FstBenchmark.serializeConsList            1000  avgt    5   151.791 Â±  45.200  us/op
FstBenchmark.serializeLinkedList          1000  avgt    5    38.139 Â±  12.932  us/op
InstrumentBenchmark.memoryOfArray         1000  avgt    5    17.700 Â±   0.068  us/op
InstrumentBenchmark.memoryOfConsList      1000  avgt    5  1706.224 Â±  61.631  us/op
InstrumentBenchmark.memoryOfLinkedList    1000  avgt    5  1866.783 Â± 557.296  us/op
</code></pre></div></div>

<ul>
  <li>There are no slowdowns in running the Enso runtime benchmark with the
instrumentation <code class="language-plaintext highlighter-rouge">javaagent</code> attached.</li>
  <li>Serialization works in microsecond time range and operates on all Java objects
implementing <em>Serializable</em> interface.</li>
  <li>Java `Instrumentation#getObjectSize() performs in nanosecond time range. The
<em>deep</em> inspection approach based on the reflection was significantly slower
than the serialization.</li>
</ul>

<p>The resulting approach can be a combination of one of the approaches with the
introspection of the value. For example, it can be a case statement, analyzing
the value and applying the appropriate method.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">long</span> <span class="nf">getSize</span><span class="o">(</span><span class="nc">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="k">instanceof</span> <span class="nc">Primitive</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">getPrimitiveSize</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="k">instanceof</span> <span class="nc">EnsoNode</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">introspectNode</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

                        
                        
                        <a href="https://github.com/luna/enso/blob/master/docs/runtime/caching.md">Open this doc on GitHub</a>
                        
                    </section>
                </div>

                 <!--<div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">

<script>
var search = instantsearch({
  appId: '3PBI3MMCBE',
  apiKey: '55d673c313b717b7386df8c9418588d4',
  indexName: 'jekyll',
  searchFunction(helper) {
    var container = document.querySelector('#search-hits');
    container.style.display = helper.state.query === '' ? 'none' : '';

    helper.search();
  }
});

var hitTemplate = function(hit) {
  let date = '';
  if (hit.date) {
    date = moment.unix(hit.date).format('MMM D, YYYY');
  }

  let url = `${hit.url}#${hit.anchor}`;

  var title = hit._highlightResult.title.value;

  var content = hit._highlightResult.html.value;

  return `
    <li class="post-item chapter">
      <a href="${url}" class="post-link">${title}</a>
      <div class="post-snippet">${content}</div>
    </li>
  `;
}


search.addWidget(
  instantsearch.widgets.searchBox({
    container: '#search-searchbar',
    placeholder: 'Search the docs',
    poweredBy: true // This is required if you're on the free Community plan
  })
);

search.addWidget(
  instantsearch.widgets.hits({
    container: '#search-hits',
    templates: {
      item: hitTemplate
    }
  })
);

search.start();
</script>

<style>
.ais-search-box {
  max-width: 100%;
  margin-bottom: 15px;
}
.post-item {
  margin-bottom: 30px;
}
.post-link .ais-Highlight {
  color: #111;
  font-style: normal;
  text-decoration: underline;
}
.post-breadcrumbs {
  color: #424242;
  display: block;
}
.post-breadcrumb {
  font-size: 18px;
  color: #424242;
}
.post-breadcrumb .ais-Highlight {
  font-weight: bold;
  font-style: normal;
}
.post-snippet .ais-Highlight {
  color: #2a7ae2;
  font-style: normal;
  font-weight: bold;
}
.post-snippet img {
  display: none;
}

.post-list {
    list-style:none;
    margin:0;
    padding: 10px 15px;
    -webkit-transition:top .5s ease;
    -moz-transition:top .5s ease;
    -o-transition:top .5s ease;
    transition:top .5s ease
}

#search-hits::after {
    content: '';
    display: block;
    height: 1px;
    margin: 7px 0;
    overflow: hidden;
    background: rgba(0,0,0,.07);
}
</style>-->
            </div>
        </div>
    </div>
</div>

                <a href="/docs/runtime/" class="navigation navigation-prev navigation-unique" aria-label="Previous page: Enso Runtime">
                    <i class="fa fa-angle-left"></i>
                </a>
                

                
                    <a href="/docs/runtime/demand-analysis.html" class="navigation navigation-next navigation-unique" aria-label="Next page: Demand Analysis">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            
            </div>

            <script>
            var gitbook = gitbook || [];
            gitbook.push(function() {
                gitbook.page.hasChanged({
    "page": {
        "title": "Introduction",
        "level": "1.1",
        "depth": 1,
        
        "dir": "ltr"
    },    "config": {
        "plugins": ["fontsettings", "highlight", "livereload", "lunr", "search", "sharing", "theme-default", "livereload"],
        "styles": {
            "ebook": "styles/ebook.css",
            "epub": "styles/epub.css",
            "mobi": "styles/mobi.css",
            "pdf": "styles/pdf.css",
            "print": "styles/print.css",
            "website": "styles/website.css"
        },
        "pluginsConfig": {
            "fontsettings": {
                "family": "sans",
                "size": 2,
                "theme": "white"
            },
            "highlight": {},
            "livereload": {},
            "lunr": {
                "ignoreSpecialCharacters": false,
                "maxIndexSize": 1000000
            },
            "search": {},
            "sharing": {
                "all": ["facebook", "google", "twitter", "weibo", "instapaper"],
                "facebook": true,
                "google": false,
                "instapaper": false,
                "twitter": true,
                "vk": false,
                "weibo": false
            },
            "theme-default": {
                "showLevel": false,
                "styles": {
                    "ebook": "styles/ebook.css",
                    "epub": "styles/epub.css",
                    "mobi": "styles/mobi.css",
                    "pdf": "styles/pdf.css",
                    "print": "styles/print.css",
                    "website": "styles/website.css"
                }
            }
        },
        "theme": "default",
        "author": "Tao He",
        "pdf": {
            "pageNumbers": true,
            "fontSize": 12,
            "fontFamily": "Arial",
            "paperSize": "a4",
            "chapterMark": "pagebreak",
            "pageBreaksBefore": "/",
            "margin": {
                "right": 62,
                "left": 62,
                "top": 56,
                "bottom": 56
            }
        },
        "structure": {
            "langs": "LANGS.md",
            "readme": "README.md",
        },
        "variables": {},
        "title": "Enso Developer Documentation",
        "language": "en",
        "gitbook": "*"
    },
    "file": {
        "path": "docs/runtime/caching.md",
        "mtime": "",
        "type": "markdown"
    },
    "gitbook": {
        "version": "3.2.3",
        "time": "2020-06-16 16:19:04 +0000"
    },
    "basePath": "",
    "book": {
        "language": ""
    }
});
            });
            </script>
        </div><script src="/gitbook/gitbook.js"></script>
<script src="/gitbook/theme.js"></script>

<script src="/gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>

<!-- <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
<script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
<script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
<script src="../gitbook/gitbook-plugin-search/search.js"></script> --></body>
</html>